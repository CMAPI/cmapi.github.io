/*! cmapi 20-03-2015 */
var cmajs=function(){function a(){var a,b=j.length;for(a=0;b>a;a++)j[a]()}function b(){}function c(){}function d(a){function b(){cmajs.publish({channel:"map.message.cancel",payload:{messageId:messageId}})}var c,d;return c=a.payload.hasOwnProperty("messageId")?a.payload.messageId:g.utils.getUUID(),d={valid:!1,errors:[],payload:a.payload,messageId:c,channel:a.channel,cancel:b}}var e,f,g,h=!1,i={},j=[];return f=function(){var a,b={};return a={add:function(a){b[a]=a},remove:function(a){delete b[a]},publish:function(a){var c,d;for(c in b)if(b.hasOwnProperty(c)&&(d=b[c],void 0!==d&&null!==d&&d.hasOwnProperty("publish")))try{d.publish(a)}catch(e){g.utils.logError(e)}},unsubscribe:function(a){var c,d;for(c in b)if(b.hasOwnProperty(c)&&(d=b[c],void 0!==d&&null!==d&&d.hasOwnProperty("unsubscribe")))try{d.unsubscribe(a)}catch(e){g.utils.logError(e)}},subscribe:function(a){var c,d;for(c in b)if(b.hasOwnProperty(c)&&(d=b[c],void 0!==d&&null!==d&&d.hasOwnProperty("subscribe")))try{d.subscribe(a)}catch(e){g.utils.logError(e)}}}}(),g={setup:{},utils:{},runtimes:{},channels:{MAP_DRAGDROP:"map.drag-drop",MAP_ERROR:"map.error",MAP_FEATURE_CLICKED:"map.feature.clicked",MAP_FEATURE_DESELECTED_BATCH:"map.feature.deselected.batch",MAP_FEATURE_DESELECTED:"map.feature.deselected",MAP_FEATURE_DRAW_PROGRESS:"map.feature.draw.progress",MAP_FEATURE_DRAW:"map.feature.draw",MAP_FEATURE_EDIT_PROGRESS:"map.feature.edit.progress",MAP_FEATURE_EDIT:"map.feature.edit",MAP_FEATURE_GET:"map.feature.get",MAP_FEATURE_HIDE:"map.feature.hide",MAP_FEATURE_MOUSEDOWN:"map.feature.mousedown",MAP_FEATURE_MOUSEUP:"map.feature.mouseup",MAP_FEATURE_PLOT_BATCH:"map.feature.plot.batch",MAP_FEATURE_PLOT:"map.feature.plot",MAP_FEATURE_PLOT_URL:"map.feature.plot.url",MAP_FEATURE_SELECTED_BATCH:"map.feature.selected.batch",MAP_FEATURE_SELECTED:"map.feature.selected",MAP_FEATURE_SHOW:"map.feature.show",MAP_FEATURE_UNPLOT_BATCH:"map.feature.unplot.batch",MAP_FEATURE_UNPLOT:"map.feature.unplot",MAP_FEATURE_UPDATE:"map.feature.update",MAP_GET:"map.get",MAP_MENU_CLICKED:"map.menu.clicked",MAP_MENU_CREATE:"map.menu.create",MAP_MENU_REMOVE:"map.menu.remove",MAP_MESSAGE_CANCEL:"map.message.cancel",MAP_MESSAGE_PROGRESS:"map.message.progress",MAP_OVERLAY_CLUSTER_ACTIVATE:"map.overlay.cluster.activate",MAP_OVERLAY_CLUSTER_DEACTIVATE:"map.overlay.cluster.deactivate",MAP_OVERLAY_CLUSTER_REMOVE:"map.overlay.cluster.remove",MAP_OVERLAY_CLUSTER_SET:"map.overlay.cluster.set",MAP_OVERLAY_CREATE:"map.overlay.create",MAP_OVERLAY_FEATURES_GET:"map.overlay.features.get",MAP_OVERLAY_GET:"map.overlay.get",MAP_OVERLAY_HIDE:"map.overlay.hide",MAP_OVERLAY_REMOVE:"map.overlay.remove",MAP_OVERLAY_SHOW:"map.overlay.show",MAP_OVERLAY_UPDATE:"map.overlay.update",MAP_STATUS_ABOUT:"map.status.about",MAP_STATUS_FORMAT:"map.status.format",MAP_STATUS_INITIALIZATION:"map.status.initialization",MAP_STATUS_REQUEST:"map.status.request",MAP_STATUS_SELECTED:"map.status.selected",MAP_STATUS_VIEW:"map.status.view",MAP_VIEW_AREA_SELECTED:"map.view.area.selected",MAP_VIEW_CENTER_BOUNDS:"map.view.center.bounds",MAP_VIEW_CENTER_FEATURE:"map.view.center.feature",MAP_VIEW_CENTER_LOCATION:"map.view.center.location",MAP_VIEW_CENTER_OVERLAY:"map.view.center.overlay",MAP_VIEW_CLICKED:"map.view.clicked",MAP_VIEW_MOUSEDOWN:"map.view.mousedown",MAP_VIEW_MOUSEUP:"map.view.mouseup",MAP_VIEW_ZOOM:"map.view.zoom"},schemas:{append:function(a){var b;for(b in a)a.hasOwnProperty(b)&&(i[b]=a[b].schema)},retrieve:function(a){return i[a]}},ready:function(a){h===!0?a():readyCallback.push(a)},publish:function(a){var b,c={valid:!1};return a.hasOwnProperty("strict")||(a.strict=!1),b=g.schemas.retrieve(a.channel),b&&(c=d(a),c=g.utils.validateMessage(c,a.strict,b),c.valid===!0&&(a.hasOwnProperty("onComplete")&&listener.setItem(c.messageId,a.onComplete),a.hasOwnProperty("onProgess")&&listener.setItem(c.messageId,a.onComplete),f.publish(c))),c},subscribe:function(a){var b,c;if(g.utils.isArray(a))for(c=a.length,b=0;c>b;b++)f.subscribe(a[b]);else f.subscribe(a)},unsubscribe:function(a){var b,c;if(g.utils.isArray(a))for(c=a.length,b=0;c>b;b++)f.unsubscribe(a[b]);else f.unsubscribe(a)},init:function(d){var i,j;if(cmapi&&cmapi.hasOwnProperty("channel")&&g.schemas.append(cmapi.channel),h||(e=new g.utils.Hash,h=!0,a(),g.subscribe([{channel:"map.message.complete",callback:b},{channel:"map.message.progress",callback:c}])),d&&d.hasOwnProperty("runtimes")&&g.utils.isArray(d.runtimes))for(j=d.runtimes.length,i=0;j>i;i++)f.add(d.runtimes[i])}}}();cmajs.utils.Hash=function(){var a;for(this.length=0,this.items=[],a=0;a<arguments.length;a+=2)"undefined"!=typeof arguments[a+1]&&(this.items[arguments[a]]=arguments[a+1],this.length+=1);this.removeItem=function(a){var b;return"undefined"!=typeof this.items[a]&&(this.length-=1,b=this.items[a],delete this.items[a]),b},this.getItem=function(a){return this.items[a]},this.setItem=function(a,b){var c;return"undefined"!=typeof b&&("undefined"==typeof this.items[a]?this.length+=1:c=this.items[a],this.items[a]=b),c},this.hasItem=function(a){return"undefined"!=typeof this.items[a]},this.clear=function(){var a;for(a in this.items)this.items.hasOwnProperty(a)&&delete this.items[a];this.length=0}},function(){cmajs&&cmajs.utils&&(cmajs.utils.getObjectFromSchema=function(a){function b(a){var b,c;for(b in a)a.hasOwnProperty(b)&&(c=b[b])}var c,d={};c=JSON.parse(a);try{d=b(c)}catch(e){d={},cmajs.utils.logMessage("An object template could not be generated from the JSON schema due to an error.  See the following error to find cause"),cmajs.utils.logError(e)}return d})}(),function(){function a(){var a={init:function(){return cmajs.utils.logMessage("The init method has not been implemented by this environment"),!1},destroy:function(){return cmajs.utils.logMessage("The destroy method has not been implemented by this environment"),!1},pubSub:{publish:function(){return cmajs.utils.logMessage("pubSub.publish has not been implemented by this environment"),!1},subscribe:function(){return cmajs.utils.logMessage("pubSub.subscribe has not been implemented by this environment"),!1},unsubscribe:function(){return cmajs.utils.logMessage("pubSub.unsubscribe has not been implemented by this environment"),!1}},getInstanceId:function(){return void cmajs.utils.logMessage("getInstanceId has not been implemented by this environment")},name:"Unnamed Environment",version:"1.0.0",sender:{id:cmajs.utils.getUUID()}};return a}cmajs.utils.getRuntimeTemplate=a}(),function(){function a(a){var b=16*Math.random()|0,c="x"===a?b:3&b|8;return c.toString(16)}function b(){for(var b,d=!0;d;)b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a),c[b]||(c[b]=b,d=!1);return b}var c={};cmajs.utils.getUUID=b}(),function(){function a(a){return"[object Array]"===Object.prototype.toString.call(a)}cmajs.utils.isArray=a}(),function(){function a(a){console&&console.hasOwnProperty("error")&&console.error(a)}cmajs.utils.logError=a}(),function(){function a(a){console&&console.hasOwnProperty("log")&&console.log(a)}cmajs.utils.logMessage=a}(),function(){function a(a,b,c){var d,e;for(d=1>=c?"The message payload is not valid:  ":"The message payload "+b+" of "+c+" is not valid:  ",e=0;e<a.length;e++)d+="\n "+a[e].message+" "+a[e].schemaPath+" "+a[e].dataPath;return d}function b(b,c,d){var e,f,g,h=b.payload,i=!1,j=b;if("string"==typeof h)try{h=JSON.parse(h),i=!0}catch(k){cmajs.utils.logError(k)}else"object"==typeof h&&(i=!0);if(i===!0)for(c!==!0&&(c=!1),cmajs.utils.isArray(h)||(h=[h]),f=h.length,e=0;f>e;e++)g=tv4.validateMultiple(h[e],d,!0,c),j.valid=g.valid,g.valid===!1&&j.errors.push(a(g.errors,e,f));return j}cmajs.utils.validateMessage=b}(),function(){var a=cmajs.utils.getRuntimeTemplate(),b=cmajs.utils.getUUID();a.name="Browser",a.getInstanceId=function(){return b},a.init=function(a){a&&a.hasOwnProperty("initcallback")&&a.initcallback()},a.pubSub.publish=function(a){var c=!1;return cmajs.runtime.browser.mediator.publish({channel:a.channel,message:a.message,sender:{id:b}}),c=!0},a.pubSub.subscribe=function(a){var b=!1;return cmajs.runtime.browser.mediator.subscribe({channel:a.channel,callback:a.callback}),b=!0},a.pubSub.unsubscribe=function(a){var b=!1;return cmajs.runtime.browser.mediator.unsubscribe({channel:a.channel,callback:a.callback}),b=!0},cmajs.runtimes.browser=a}(),function(){cmajs.runtimes.browser.mediator=function(){var a=new cmajs.utils.Hash,b={subscribe:function(b){if(null!==a.getItem(b.channel)&&void 0!==a.getItem(b.channel))a.getItem(b.channel).push(b.callback);else{var c=[];c.push(b.callback),a.setItem(b.channel,c)}},unsubscribe:function(b){var c,d,e;if(null!==a.getItem(b.channel)&&void 0!==a.getItem(b.channel))for(c=a.getItem(b.channel),d=c.length,e=0;d>e;e+=1)if(c[e]===b.callback)return c.splice(e,1),!0;return!1},publish:function(b){var c,d,e=a.getItem(b.channel),f={success:!1,message:"An unanticipated error has occurred in cmajs.runtime.browser.mediator.dispatch"};try{if("string"==typeof b.message&&(b.message=JSON.parse(b.message)),null!==e&&void 0!==e)for(c=e.length,d=0;c>d;d+=1)if(null!==e[d])try{e[d](b.sender,b.message,b.channel)}catch(g){}}catch(h){f={success:!1,message:h.toString()}}return f}};return b}()}(),tv4||cmajs.utils.logMessage("tv4 is not availble and required to use the cmajs library.  Please include tv4.js on the page bdofre the cmajs include.  See https://github.com/geraintluff/tv4 or use the tv4.min.js file located in the libs driectory of the cmajs project"),cmajs.init();